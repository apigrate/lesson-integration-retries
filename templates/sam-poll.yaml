#
# Archetype for a polling-triggered integration.
#   Defines:
#    1. processing queue
#    2. dead letter queue
#    3. lambda to enqueue (i.e. poll) data
#    4. lambda to process enqueued data
#
# To save time, replace the following (case-sensistive):
#   myapp => with name of app abbreviation (lowercase)
#   Entities => with plural name of entity (Title Case), e.g. "Tickets", "Accounts" etc.
#   entities => with plural name of entity (lowercase), e.g. "tickets", "accounts" etc.
#   Entity => with name of entity (Title Case), e.g. "Ticket", "Account" etc.
#   entity => with name of entity (lowercase), e.g. "ticket", "account" etc.
#
AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: Cloud automation scripts for myapp.
Parameters:
  lambdaExecutionRole:
    Description: 'Required. The role used for lambda execution.'
    Type: 'String'
    Default:
      Fn::Sub: 'arn:aws:iam::${AWS::AccountId}:role/LambdaExecutionRole'

Globals:
  Function:
    CodeUri: ../dist
    Runtime: nodejs14.x
    MemorySize: 256
    Timeout: 60
    # Make sure to change the layer version below if you make a new common layer deployment.
    Layers:
      - 'arn:aws:lambda:us-east-1:nnnnnnnnnnn:layer:myapp-serverless-common:1'

Resources:
  # If more than one automation for a client, you can share common libraries in a layer.
  # You may wish to deploy the layer in a separate SAM file.
  # CommonDependenciesLayer:
  #   Type: AWS::Serverless::LayerVersion
  #   Properties:
  #     LayerName: myapp-common-deps
  #     Description: Common dependencies for my apps
  #     ContentUri: ../common-deps/
  #     RetentionPolicy: Retain

  # Queue names should evoke what is being stored...
  
  # A dead-letter queue.
  entityQueueDL:
    Type: 'AWS::SQS::Queue'
    Properties: 
      MessageRetentionPeriod: 345600
      QueueName: 'entities-dlq'
      VisibilityTimeout: 90

  # The queue for messages.
  entityQueue:
    Type: 'AWS::SQS::Queue'
    Properties: 
      MessageRetentionPeriod: 345600
      QueueName: 'entities'
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt entityQueueDL.Arn
        # maxReceiveCount=1 means no retries (message is only read for processing once).
        #  if an error occurs, it is sent to the dead-letter-queue immediately.
        maxReceiveCount: 2
      VisibilityTimeout: 360
  
  pollForEntities:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: pollForEntities
      Handler: index.pollForEntities
      # Layers:
      #   - !Ref CommonDependenciesLayer  ...or...
      #   - arn:aws:lambda:us-east-1:149827180975:layer:myapp-common-deps:5
      #   - Fn::Sub: 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer/myapp-common-deps:5'
      Description: >-
        Polls for entities since the last poll timestamp. Anything
        found is placed in an SQS queue for processing.
      Role: 
        Ref: lambdaExecutionRole
      # Defines how often to poll.
      Events:
        PollForEntitySchedule:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
      Environment:
        Variables:
          DEBUG: myapp:services
          LOG_LEVEL: info
          PROCESSING_MODE: active
          QUEUE_URL: 
            Ref: entityQueue
      Tags:
        foo: bar

  processEntity:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: processEntity
      Handler: index.processEntity
      CodeUri: ../
      Description: Processes a entity.
      Role:
        Ref: lambdaExecutionRole
      Events:
        # A Preexisting Queue should be defined to hold the queue of company updates.
        SQSEventEntityProcessing:
          Type: SQS
          Properties:
            Queue: !GetAtt entityQueue.Arn
            BatchSize: 1
      Environment:
        Variables:
          DEBUG: myapp:services
          LOG_LEVEL: info
          PROCESSING_MODE: active